<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Online Garments Store</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../public/css/checkout.css" />
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="index.html">Garments Store</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="my-account.html">Profile</a>
            </li>
            <li class="nav-item">
              <p class="nav-link" style="cursor: pointer" id="logoutBtn">
                Logout
              </p>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container my-5">
      <h1 class="text-center mb-4">Checkout</h1>
      <div class="row">
        <div class="col-md-8">
          <h4 class="mb-3">Cart Items</h4>
          <ul id="checkoutItems" class="list-group mb-4 shadow-sm"></ul>

          <h4 class="mb-3">Shipping Details</h4>
          <form id="checkoutForm" class="card p-4 shadow-sm">
            <div class="mb-3">
              <label for="address" class="form-label">Address</label>
              <input
                type="text"
                class="form-control"
                id="address"
                placeholder="Your delivery address"
                required
              />
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label">Phone</label>
              <input
                type="text"
                class="form-control"
                id="phone"
                placeholder="Your phone number"
                required
              />
            </div>
            <div class="mb-3">
              <label for="paymentMethod" class="form-label"
                >Payment Method</label
              >
              <select class="form-select" id="paymentMethod" required>
                <option value="">Select Payment Method</option>
                <option value="cash">Cash on Delivery</option>
                <option value="online">Online Payment</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              Place Order
            </button>
          </form>
        </div>

        <div class="col-md-4">
          <div class="card p-4 shadow-sm">
            <h4>Order Summary</h4>
            <p>Items: <span id="totalItems">0</span></p>
            <p>Subtotal: $<span id="subtotal">0.00</span></p>
            <hr />
            <h5 class="fw-bold">
              Total: $<span id="checkoutTotal">0.00</span>
            </h5>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../public/js/checkout.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Check token
        const token = localStorage.getItem("token");
        if (!token) {
          alert("You must be signed in to place an order.");
          window.location.href = "index.html";
          return;
        }

        const authLink = document.getElementById("auth-link");

        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("token");
          localStorage.removeItem("u2yCwN4hBx");
          sessionStorage.removeItem("token");
          sessionStorage.removeItem("u2yCwN4hBx");
          window.location.href = "../index.html";
        });

        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const checkoutItems = document.getElementById("checkoutItems");
        const totalItems = document.getElementById("totalItems");
        const subtotal = document.getElementById("subtotal");
        const checkoutTotal = document.getElementById("checkoutTotal");

        if (cart.length === 0) {
          window.location.href = "cart.html";
          checkoutItems.innerHTML =
            '<li class="list-group-item text-info">Your cart is empty.</li>';
          subtotal.textContent = "0.00";
          checkoutTotal.textContent = "0.00";
          return;
        }

        let total = 0;
        let itemCount = 0;

        checkoutItems.innerHTML = cart
          .map((item) => {
            const quantity = item.quantity || 1;
            const itemTotal = item.price * quantity;
            total += itemTotal;
            itemCount += quantity;

            return `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>${item.name}</strong><br>
            <small>Quantity: ${quantity}</small><br>
            <small>Price: $${item.price.toFixed(2)}</small>
          </div>
          <div><strong>$${itemTotal.toFixed(2)}</strong></div>
        </li>
      `;
          })
          .join("");

        totalItems.textContent = itemCount;
        subtotal.textContent = total.toFixed(2);
        checkoutTotal.textContent = total.toFixed(2);

        const checkoutForm = document.getElementById("checkoutForm");

        checkoutForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const address = document.getElementById("address").value.trim();
          const phone = document.getElementById("phone").value.trim();
          const paymentMethod = document.getElementById("paymentMethod").value;

          if (!address || !phone || !paymentMethod) {
            alert("Please fill all required fields.");
            return;
          }

          const orderData = {
            userId: localStorage.getItem("token").toString(),
            address,
            phone,
            paymentMethod,
            items: cart.map((item) => ({
              id: item.id,
              name: item.name,
              price: item.price,
              quantity: item.quantity || 1,
            })),
            totalPrice: total.toFixed(2),
          };

          try {
            const res = await fetch("/api/user/order", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(orderData),
            });

            if (!res.ok) {
              throw new Error("Order failed. Please try again.");
            }

            const data = await res.json();
            // Clear cart on success
            localStorage.removeItem("cart");
            alert("Order placed successfully! Thank you for your purchase.");
            window.location.href =
              "order-confirmation.html?trackingId=" + data.trackingId;
          } catch (error) {
            console.error(error);
            alert(error.message);
          }
        });
      });
    </script>
  </body>
</html>
