<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details - Online Garments Store</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .product-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .product-image:hover {
        transform: scale(1.05);
      }

      .thumbnail-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.3s ease;
      }

      .thumbnail-image:hover,
      .thumbnail-image.active {
        border-color: #0d6efd;
      }

      .price {
        font-size: 2rem;
        font-weight: bold;
        color: #198754;
      }

      .stock-badge {
        font-size: 0.9rem;
      }

      .category-badge {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
      }

      .btn-add-to-cart {
        padding: 12px 30px;
        font-size: 1.1rem;
        font-weight: 500;
      }

      .btn-remove-from-cart {
        padding: 12px 30px;
        font-size: 1.1rem;
        font-weight: 500;
        background-color: #dc3545;
        border-color: #dc3545;
      }

      .btn-remove-from-cart:hover {
        background-color: #c82333;
        border-color: #bd2130;
      }

      .product-title {
        font-size: 2.5rem;
        font-weight: 300;
        margin-bottom: 1rem;
      }

      .product-description {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #555;
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 400px;
      }

      .error-message {
        text-align: center;
        color: #dc3545;
        font-size: 1.2rem;
        margin-top: 2rem;
      }

      .quantity-input {
        width: 80px;
        text-align: center;
      }

      .product-section {
        margin-bottom: 2rem;
      }

      .cart-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Online Garments Store</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="cart.html">
                <i class="bi bi-cart"></i> Cart
                <span id="cartBadge" class="badge bg-primary ms-1">0</span>
              </a>
            </li>
            <li id="auth-link" class="nav-item"></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div
        id="cartToast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <i class="bi bi-cart me-2"></i>
          <strong class="me-auto">Cart Update</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
          ></button>
        </div>
        <div class="toast-body" id="toastMessage">
          <!-- Message will be inserted here -->
        </div>
      </div>
    </div>

    <div class="container mt-5">
      <!-- Loading Spinner -->
      <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="error-message d-none">
        <i class="bi bi-exclamation-triangle"></i>
        <p>
          Sorry, we couldn't load the product details. Please try again later.
        </p>
      </div>

      <!-- Product Details -->
      <div id="productDetails" class="d-none">
        <div class="row">
          <!-- Product Images -->
          <div class="col-md-6">
            <div class="product-section">
              <div class="mb-3">
                <img
                  id="mainImage"
                  src=""
                  alt="Product Image"
                  class="product-image"
                />
              </div>
              <div id="thumbnails" class="d-flex gap-2">
                <!-- Thumbnail images will be populated here -->
              </div>
            </div>
          </div>

          <!-- Product Information -->
          <div class="col-md-6">
            <div class="product-section">
              <h1 id="productName" class="product-title"></h1>

              <div class="mb-3">
                <span id="categoryBadge" class="badge category-badge"></span>
              </div>

              <div class="mb-3">
                <span id="productPrice" class="price"></span>
              </div>

              <div class="mb-3">
                <span id="stockBadge" class="badge stock-badge"></span>
              </div>

              <div class="mb-4">
                <h5>Description</h5>
                <p id="productDescription" class="product-description"></p>
              </div>

              <div class="mb-4" id="quantitySection">
                <div class="row align-items-center">
                  <div class="col-auto">
                    <label for="quantity" class="form-label">Quantity:</label>
                  </div>
                  <div class="col-auto">
                    <input
                      type="number"
                      id="quantity"
                      class="form-control quantity-input"
                      value="1"
                      min="1"
                    />
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex">
                <button
                  id="cartToggleBtn"
                  class="btn btn-primary btn-add-to-cart me-md-2"
                >
                  <i class="bi bi-cart-plus"></i> Add to Cart
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentProduct = null;

      // Get product ID from URL parameters
      function getProductIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id") || window.location.pathname.split("/").pop();
      }

      // Authentication setup
      const token = localStorage.getItem("token");
      const authLink = document.getElementById("auth-link");

      if (token) {
        authLink.innerHTML = `
            <li class="nav-item" style="display:flex;">
              <a class="nav-link" href="my-account.html">My Account</a>
              <p class="nav-link" style="cursor: pointer;" id="logoutBtn">Logout</p>
            </li>
          `;
      } else {
        authLink.innerHTML = `
            <li class="nav-item" style="display:flex;">
              <a class="nav-link" href="signin.html">Sign In</a>
              <a class="nav-link" href="signup.html">Sign Up</a>
            </li>
          `;
      }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("token");
          localStorage.removeItem("u2yCwN4hBx");
          sessionStorage.removeItem("token");
          sessionStorage.removeItem("u2yCwN4hBx");
          window.location.href = "../index.html";
        });
      }

      // Cart management functions
      const getCart = () => JSON.parse(localStorage.getItem("cart")) || [];

      const saveCart = (cart) => {
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartBadge();
      };

      const updateCartBadge = () => {
        const cart = getCart();
        const badge = document.getElementById("cartBadge");
        badge.textContent = cart.length;
      };

      const isInCart = (productId) => {
        return getCart().some((item) => String(item.id) === String(productId));
      };

      const addToCart = (product, quantity) => {
        const cart = getCart();
        const existingItem = cart.find(
          (item) => String(item.id) === String(product.id)
        );

        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({ ...product, quantity: quantity });
        }

        saveCart(cart);
        showToast(`Added ${quantity} item(s) to cart!`, "success");
        updateCartButton();
      };

      const removeFromCart = (productId) => {
        let cart = getCart();
        const originalLength = cart.length;
        cart = cart.filter((item) => String(item.id) !== String(productId));

        if (cart.length < originalLength) {
          saveCart(cart);
          showToast("Product removed from cart!", "info");
          updateCartButton();
        }
      };

      // Show toast notification
      function showToast(message, type = "success") {
        const toast = document.getElementById("cartToast");
        const toastMessage = document.getElementById("toastMessage");

        toastMessage.textContent = message;

        // Add appropriate styling based on type
        toast.classList.remove(
          "text-bg-success",
          "text-bg-danger",
          "text-bg-info"
        );
        if (type === "success") {
          toast.classList.add("text-bg-success");
        } else if (type === "error") {
          toast.classList.add("text-bg-danger");
        } else if (type === "info") {
          toast.classList.add("text-bg-info");
        }

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
      }

      // Update cart button based on cart status
      function updateCartButton() {
        const cartToggleBtn = document.getElementById("cartToggleBtn");
        const quantitySection = document.getElementById("quantitySection");
        const productId = getProductIdFromUrl();

        if (isInCart(productId)) {
          cartToggleBtn.innerHTML =
            '<i class="bi bi-cart-x"></i> Remove from Cart';
          cartToggleBtn.className =
            "btn btn-danger btn-remove-from-cart me-md-2";
          quantitySection.style.display = "none";
        } else {
          cartToggleBtn.innerHTML =
            '<i class="bi bi-cart-plus"></i> Add to Cart';
          cartToggleBtn.className = "btn btn-primary btn-add-to-cart me-md-2";
          quantitySection.style.display = "block";
        }
      }

      // Display product details
      function displayProduct(product) {
        currentProduct = product;

        document.getElementById("productName").textContent =
          product.name || "Product Name";
        document.getElementById("productDescription").textContent =
          product.description || "No description available";
        document.getElementById("productPrice").textContent = `$${
          product.price || "0.00"
        }`;
        document.getElementById("categoryBadge").textContent =
          product.category?.name || "Uncategorized";

        // Set stock badge
        const stockBadge = document.getElementById("stockBadge");
        const stock = product.stock || 0;
        if (stock > 0) {
          stockBadge.textContent = `${stock} in stock`;
          stockBadge.className = "badge bg-success stock-badge";
        } else {
          stockBadge.textContent = "Out of stock";
          stockBadge.className = "badge bg-danger stock-badge";
        }

        // Set up images
        setupProductImages(product);

        // Set up quantity input max value
        const quantityInput = document.getElementById("quantity");
        quantityInput.max = stock;

        // Enable/disable cart button based on stock
        const cartToggleBtn = document.getElementById("cartToggleBtn");
        if (stock <= 0) {
          cartToggleBtn.disabled = true;
          cartToggleBtn.innerHTML =
            '<i class="bi bi-x-circle"></i> Out of Stock';
          cartToggleBtn.className = "btn btn-secondary btn-add-to-cart me-md-2";
        } else {
          cartToggleBtn.disabled = false;
          updateCartButton();
        }
      }

      // Setup product images
      function setupProductImages(product) {
        const mainImage = document.getElementById("mainImage");
        const thumbnailsContainer = document.getElementById("thumbnails");

        const images = [
          product.image_1,
          product.image_2,
          product.image_3,
        ].filter((img) => img);

        if (images.length > 0) {
          mainImage.src = images[0];
          mainImage.alt = product.name;

          // Clear existing thumbnails
          thumbnailsContainer.innerHTML = "";

          // Create thumbnails
          images.forEach((image, index) => {
            const thumbnail = document.createElement("img");
            thumbnail.src = image;
            thumbnail.alt = `${product.name} - Image ${index + 1}`;
            thumbnail.className = `thumbnail-image ${
              index === 0 ? "active" : ""
            }`;
            thumbnail.onclick = () => {
              mainImage.src = image;
              // Update active thumbnail
              document.querySelectorAll(".thumbnail-image").forEach((thumb) => {
                thumb.classList.remove("active");
              });
              thumbnail.classList.add("active");
            };
            thumbnailsContainer.appendChild(thumbnail);
          });
        } else {
          // Use placeholder image if no images available
          mainImage.src = "https://via.placeholder.com/400x400?text=No+Image";
          mainImage.alt = "No image available";
        }
      }

      // Handle cart toggle (add/remove)
      function handleCartToggle() {
        const productId = getProductIdFromUrl();

        if (!currentProduct) {
          showToast("Product information not available", "error");
          return;
        }

        if (currentProduct.stock <= 0) {
          showToast("Product is out of stock", "error");
          return;
        }

        if (isInCart(productId)) {
          removeFromCart(productId);
        } else {
          const quantity =
            parseInt(document.getElementById("quantity").value) || 1;

          // Validate quantity
          if (quantity > currentProduct.stock) {
            showToast(
              `Only ${currentProduct.stock} items available in stock`,
              "error"
            );
            return;
          }

          if (quantity < 1) {
            showToast("Please select a valid quantity", "error");
            return;
          }

          addToCart(currentProduct, quantity);
        }
      }

      // Load product details
      async function loadProductDetails() {
        const productId = getProductIdFromUrl();

        if (!productId) {
          showError("Product ID not found in URL");
          return;
        }

        try {
          const response = await fetch(`/api/admin/product/${productId}`);

          if (!response.ok) {
            throw new Error("Failed to fetch product details");
          }

          const product = await response.json();
          console.log(product);
          displayProduct(product.data);

          // Hide loading spinner and show product details
          document.getElementById("loadingSpinner").classList.add("d-none");
          document.getElementById("productDetails").classList.remove("d-none");
        } catch (error) {
          console.error("Error loading product details:", error);
          showError("Failed to load product details");
        }
      }

      // Show error message
      function showError(message) {
        document.getElementById("loadingSpinner").classList.add("d-none");
        document.getElementById("errorMessage").classList.remove("d-none");
        document.getElementById("errorMessage").querySelector("p").textContent =
          message;
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize cart badge
        updateCartBadge();

        // Load product details
        loadProductDetails();

        // Add event listener for cart toggle button
        document
          .getElementById("cartToggleBtn")
          .addEventListener("click", handleCartToggle);
      });
    </script>
  </body>
</html>
